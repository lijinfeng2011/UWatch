var nodes=null;var shouldOpenSMT=false;$(document).on("pageshow","#pageSubscribe",function(){$("#filterPanel").panel({beforeclose:function(a,b){setTimeout(closeFilterPanel,500)}});$("#searchPanel").panel({beforeclose:function(a,b){if(shouldOpenSMT){$("#smt-form").show();shouldOpenSMT=false}}});$("#openFilterPanel").unbind("click",openFilterPanel).bind("click",openFilterPanel);$("#openSearchPanel").unbind("click",openSearchPanel).bind("click",openSearchPanel);$("#bizGroup").unbind("click",filterBusiness).bind("click",filterBusiness);$("#nsForm").unbind("submit",searchNode).bind("submit",searchNode);$("#nsForm .ui-input-clear").unbind("click",searchNode).bind("click",searchNode);$("#hsForm").unbind("submit",searchHermes).bind("submit",searchHermes);$("#hsForm .ui-input-clear").unbind("click",searchHermes).bind("click",searchHermes)});$(document).on("pagebeforehide","#pageSubscribe",function(){Panel.closeSMT()});function ajaxFormSubmit(b){var e="";var a="";var f=$(b.target).closest(".subscribe-box");$.each(f.find(".ui-checkbox"),function(j,h){var g=$(h).find('input[type="checkbox"]').attr("name");var i=$(h).find("label").hasClass("ui-checkbox-on")?1:0;if(e){a="&"+g+"="+i}else{a="?"+g+"="+i}e=e+a});e=e+"&hermesID="+f.find('input[name="hermesID"]').val();var c={url:"/ajaxBookSubscribe"+e,before:showLoader,success:d,complete:hideLoader,error:ajax_error};sendAjaxRequest(c);function d(g){if(g.response===0){popOver("恭喜！成功了yeah～")}if(g.response===1){popOver("Sorry，稍后再试下嘛！")}if(g.response===2){popOver("请先添加接受报警方式后再订阅！")}if(g.response===3){popOver("订阅成功，记得打开接收报警选项哦～")}}}function ajaxGetSubDetail(d){var a=d;var b={url:"/ajaxGetSubDetail?group="+a.attr("data-name"),before:showLoader,success:c,complete:hideLoader,error:ajax_error};sendAjaxRequest(b);function c(f){var g="",e=0;if(f.subDetail!=null&&f.subDetail.length>0){g='<div class="subscribe-box"><fieldset data-role="controlgroup">';$.each(f.subDetail,function(i,h){if(h.level==1){g=g+'<label for="'+h.name+'" style="color:orange">'+h.name+'<p style="display:inline">&nbsp级别低</p>'}else{if(h.level==3){g=g+'<label for="'+h.name+'" style="color:red">'+h.name+'<p style="display:inline">&nbsp级别高</p>'}else{g=g+'<label for="'+h.name+'">'+h.name}}if(h.alias){g=g+'<p style="display:inline"> '+h.alias+"</p></label>"}else{g=g+"</label>"}if(h.booked){g=g+'<input type="checkbox" name="'+h.name+'" id="'+h.name+'" checked="checked">'}else{g=g+'<input type="checkbox" name="'+h.name+'" id="'+h.name+'">'}});g=g+"</fieldset>";g=g+'<input type="hidden" name="hermesID" value="'+a.attr("data-name")+'">';g=g+'<input type="button" onclick="ajaxFormSubmit(event)" value="提交选择"></div>';e=1}else{g="<p>无法获得订阅信息!</p>"}a.find(".content").html(g).trigger("create");if(Panel){Panel.openSMT(a)}}}function openSearchPanel(){var b=$("#smt-form");var a=Panel.getOpenedForm();if(b.is(":visible")&&a){$("#hsForm").find('input[name="hermesName"]').val(a.attr("data-name"));$("#smt-form").hide();shouldOpenSMT=true}else{shouldOpenSMT=false;$("#hsForm").find('input[name="hermesName"]').val("")}searchHermes()}function openFilterPanel(){if(localStorage.filterBiz){var c=localStorage.filterBiz.split("-");for(var a in c){$("input[name='"+c[a]+"']").attr("checked",true).checkboxradio("refresh")}}if(sessionStorage.getItem("filterNode")){$('input[name="nodeName"]').val(sessionStorage.getItem("filterNode"))}if(sessionStorage.getItem("filterBizs")){var b=$("#nodeFilterList");var c=sessionStorage.getItem("filterBizs").split(":");for(var a in c){$("<li>"+c[a]+"</li>").appendTo(b)}b.listview("refresh")}}function filterBusiness(c){var a=$(c.target).closest(".ui-checkbox");var b=new Array();$.each($("#bizGroup").find(".ui-checkbox"),function(f,d){var e=$(d).find("label");if($(d).get(0)==a.get(0)){if(e.hasClass("ui-checkbox-off")){b.push(e.text())}}else{if(e.hasClass("ui-checkbox-on")){b.push(e.text())}}});if(b.length>0){localStorage.filterBiz=b.join("-")}else{localStorage.filterBiz=""}}function closeFilterPanel(){var b=(sessionStorage.getItem("filterBizs")&&sessionStorage.getItem("filterBizs")!=null)?sessionStorage.getItem("filterBizs"):"";var a=$("#bizSetting").attr("action")+"?fname="+localStorage.filterBiz+"&fbiz="+b;$("#bizSetting").attr("action",a).submit()}function searchNode(b){b.preventDefault();b.stopPropagation();nodes=$('input[name="nodeName"]').val();nodes=nodes.replace(/(^\s*)|(\s*$)/g,"");if(!nodes){sessionStorage.setItem("filterNode","");sessionStorage.setItem("filterBizs","");$("#nodeFilterList").empty();return false}sendAjaxRequest({url:"/ajaxGetBizByNode?node="+nodes,before:showLoader,success:a,complete:hideLoader,error:ajax_error});return false;function a(f){var d=false,e=new Array();var c=$("#nodeFilterList");c.empty();$("#mbox-bizs").show();$.each(f.bizList,function(h,g){$("<li>"+g+"</li>").appendTo(c);e.push(g);d=true});if(d){$("#mbox-bizs").hide();c.listview("refresh")}if(e.length){sessionStorage.setItem("filterNode",nodes);sessionStorage.setItem("filterBizs",e.join(":"))}else{sessionStorage.setItem("filterNode","");
sessionStorage.setItem("filterBizs","")}}}function searchHermes(b){b&&b.preventDefault();b&&b.stopPropagation();var d=$("#diagramList").empty();var e=$("#hermesFilterList").empty();var i=$('input[name="hermesName"]').val();i=i.replace(/(^\s*)|(\s*$)/g,"");if(!i){return false}var h=["CPU","MEM","IFACE","LOAD"],a="/getGraph?small=1&name="+i,g="/getGraph?small=0&name="+i,f="/images/no_image.jpg";$.each(h,function(k,j){$('<li data-role="list-divider"></li>').text(j+"图表").appendTo(d);$('<a target="_blank"></a>').attr("href",g+"&type="+j).html('<img width="240" height="130" onerror="this.src=&quot'+f+'&quot" src="'+a+"&type="+j+'">').appendTo(d)});d.listview("refresh");sendAjaxRequest({url:"/ajaxGetNodesByHermes?hermes="+i,before:showLoader,success:c,complete:hideLoader,error:ajax_error});function c(k){var j=false;$("#mbox-hermes").show();$.each(k.nodesList,function(m,l){$('<li data-role="list-divider">'+m+"</li>").appendTo(e);$.each(l,function(p,o){$("<li>"+o+"</li>").appendTo(e)});j=true});if(j){$("#mbox-hermes").hide();e.listview("refresh")}}};