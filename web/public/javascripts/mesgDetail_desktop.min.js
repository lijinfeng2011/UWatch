var pullUpEl=document.getElementById("pullUp"),pullDownEl=document.getElementById("pullDown"),$mesgList=$("#contentList1"),$target=null;$(document).on("pagebeforeshow","#mesgDetail",function(){if(sessionStorage.getItem("glanceView")=="oncall"){$("#cancelBtn").attr("disabled","true")}});$(document).on("pagebeforehide","#mesgDetail",function(){$(".webui-popover").remove()});$(document).on("pageshow","#mesgDetail",function(){$("#mesgDetail #contentList1").undelegate("li","click",showPopover).delegate("li","click",showPopover)});function showPopover(e,b){if(b==="fake"){return false}if($target&&$target.get(0)==$(e.currentTarget).get(0)){$target=null;$(".webui-popover").remove();return}$target=$(e.currentTarget);var d=$target.find(".node").text();var f=$target.offset().top-$(document).scrollTop()<400?"bottom":"top";$(".webui-popover").remove();var a={placement:f,trigger:"click",title:"详细信息",width:1060,height:310,multi:false,closeable:true,style:"",arrow:true,padding:true};var c={cache:false,url:"/ajaxGetNodeDetail?node="+d,type:"async",dataType:"json",content:function(n){var j=$("#popover-model").clone();$.each(n.detail,function(o,p){if(o==="node"){j.find("#machineName").text(p)}else{if(o==="hermes"){j.find("#bizName").text(p)}else{if(o==="oncaller"){j.find("#oncaller").text(p)}}}});var k=$target.find(".detail").text().split("#");var m=j.find("#machineName").text();var g=k[0].split(m);j.find("#alarmTime").text(g[0]);j.find("#alarmInfo").text(k[1]);var l=["CPU","MEM","IFACE","LOAD"];var i="/getGraph?small=1&name="+m;var h="/getGraph?small=0&name="+m;$.each(l,function(p,o){j.find("#"+o).attr("src",i+"&type="+o).closest("a").attr("href",h+"&type="+o)});$('<input name="stopPrd" id="stopPrd" placeholder="选择时间间隔" data-role="datebox">').attr("data-options",'{"mode":"durationbox"}').appendTo(j.find(".stopAlarm"));$('<input name="stopPrdGrp" id="stopPrdGrp" placeholder="时间间隔" data-role="datebox">').attr("data-options",'{"mode":"durationbox"}').appendTo(j.find(".stopAlarmGrp"));setTimeout(function(){$("#stopPrd").textinput().datebox();$("#stopPrdGrp").textinput().datebox()},100);return j.css("display","inline-block").html()}};$target.webuiPopover("destroy").webuiPopover($.extend({},a,c)).trigger("click",["fake"])}function pullUpAction(a){$(".webui-popover").remove();setTimeout(function(){var d="",c=0;$.each(a.response,function(f,e){c++;d=d+'<li class="gary"><span class="index hide">';d=d+e.idx;d=d+'</span><span class="node hide">';d=d+e.node;d=d+'</span><span class="detail"> ';d=d+e.content;d=d+"</span></li>"});if(c>0){var b=parseInt($(".listHeader").find(".count").text())+c;$(".listHeader").find(".count").text(b)}$mesgList.append(d).listview("refresh");pullUpEl.className="";pullUpEl.querySelector(".pullUpLabel").innerHTML="点击此处获取历史数据..."},100)}function pullDownAction(a){$(".webui-popover").remove();setTimeout(function(){var d="",c=0;$.each(a.response,function(f,e){c++;d=d+'<li data-swipeurl="#"><span class="index hide">';d=d+e.idx;d=d+'</span><span class="node hide">';d=d+e.node;d=d+'</span><span class="detail"> ';d=d+e.content;d=d+"</span></li>"});$mesgList.find("li").removeClass("gary").addClass("gary");$(".filterBtn").attr("disabled","true");var b=parseInt($(".listHeader").find(".count").text())+c;$(".listHeader").find(".count").text(b);$mesgList.prepend(d).listview("refresh");pullDownEl.className="";pullDownEl.querySelector(".pullDownLabel").innerHTML="点击此处获取最新数据..."},100)}function getHistory(){pullUpEl.className="loading";pullUpEl.querySelector(".pullUpLabel").innerHTML="加载中...";var a=$("#contentList1>li:last").find(".index").text();sendAjaxRequest({url:"/ajaxGetMessage?type=old&id="+$(".hermesName").text()+"&pos="+a,before:function(){},success:pullUpAction,complete:function(){},error:function(){}})}function getNew(){pullDownEl.className="loading";pullDownEl.querySelector(".pullDownLabel").innerHTML="加载中...";sendAjaxRequest({url:"/ajaxGetMessage?type=new&id="+$(".hermesName").text(),before:function(){},success:pullDownAction,complete:function(){},error:function(){}})}function cancelSub(d){var a=d.split(/\./);if(a.length<2){return}var b=a[0];var c=d.substring(b.length+1,d.length);sendAjaxRequest({url:"/ajaxBookSubscribe?hermesID="+b+"&"+c+"=0",before:showLoader,success:responseCancel,complete:hideLoader,error:ajax_error})}function responseCancel(a){if(a.response===1){popOver("Sorry，稍后再试下嘛！")}else{if(a.response===0||a.response===3){$("#contentList1").find("li").removeClass("gary").addClass("gary");$("#cancelBtn").attr("disabled","true").text("取消成功");popOver("取消订阅成功了yeah～")}}}function filter(a){var g=$(a.target);var f;var i;if(g.attr("id")==="single"){f=g.parents(".webui-popover-content").find("#stopPrd").val()}else{if(g.attr("id")==="group"){var c=g.parents(".webui-popover-content");f=c.find("#stopPrdGrp").val();i=$.trim(c.find("#hermesString").val());if(i.length==0){popOver("请设置机器群组信息");return false}}}if(f.length==0||f==="0 天, 00:00:00"){popOver("请设置屏蔽时间");return false}var h=f.split(",");var e=h[0].split(" ");var b=parseInt(e[0])*24*3600;
e=h[1].split(":");b+=parseInt(e[0])*3600+parseInt(e[1])*60+parseInt(e[2]);var d=$(".hermesName").text();if(g.attr("id")==="single"){sendAjaxRequest({url:"/ajaxSetFilterMessage?name="+d+"&node="+$target.find(".node").text()+"&time="+b,before:function(){},complete:function(){},error:function(){},success:function(j){if(j.response==0&&$target){$target.removeClass("green").addClass("green")}popOver("屏蔽成功了yeah~!")}})}else{if(g.attr("id")==="group"){sendAjaxRequest({url:"/ajaxGetNodes?name="+d+"&hms="+i+"&time="+b,before:function(){},complete:function(){},error:function(){},success:function(j){if(j.nodes==1){popOver("屏蔽失败!")}else{if(j.nodes==2){popOver("一次不能超过20台机器!")}else{if(j.nodes==3){popOver("机器格式不合法!")}else{popConfirmation(j)}}}}})}}};