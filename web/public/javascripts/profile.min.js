var TIMEOUT=30;var _countdown=0;$(document).on("pageload","#profile",function(){$("#methodBtn").click(ajaxSubmitMethod)});$(document).on("pageshow","#profile",function(){$(".filter-collapse").collapsible({expand:function(b,c){getFilterItems()},collapse:function(b,c){$("#filterList").empty()}});var a=$("#alarmValue").hasClass("ui-checkbox-on")?"on":"off";if(a=="off"){$(".alarm-change input[name='fullFormat']").checkboxradio("disable");$("#alarm-form input[type='button']").button("disable");$("#alarm-form input[type='text']").textinput("disable");$("#alarm-form input[type='tel']").textinput("disable");$("#alarm-form label").css("color","#aaa")}else{$(".alarm-change input[name='fullFormat']").checkboxradio("enable");$("#alarm-form input[type='button']").button("enable");$("#alarm-form input[type='text']").textinput("enable");$("#alarm-form input[type='tel']").textinput("enable");$("#alarm-form label").css("color","")}});$(document).on("pagehide","#profile",function(){_countdown=0});function getFilterItems(){sendAjaxRequest({url:"/ajaxGetFilterItems",before:showLoader,success:a,complete:hideLoader,error:ajax_error});function a(c){var d=0;var b=$("#filterList");$.each(c.response,function(j,g){var i=$("<li></li>").appendTo(b);var f=$('<div data-role="collapsible" class="filter-collapse" data-name="'+j+'">');$('<h3 style="margin: 0;"><span class="item">'+j+"</span></h3>").appendTo(f);var e=$('<div class="subscribe-box"></div>');var h=$('<fieldset data-role="controlgroup"></fieldset>').appendTo(e);$.each(g,function(k,l){var m=l.split(":");d++;$('<label for="'+m[0]+":"+d+'">'+m[0]+" (by:"+m[1]+")</label>").appendTo(h);if(m[2]=="1"){$('<input type="checkbox" name="'+m[0]+'" id="'+m[0]+":"+d+'" onclick="filterRequest(event)" checked="checked">').appendTo(h)}else{$('<input type="checkbox" name="'+m[0]+'" id="'+m[0]+":"+d+'" disabled="disabled" checked="checked">').appendTo(h)}});e.appendTo($('<div class="content"></div>').appendTo(f));f.appendTo(i)});$(".filter-collapse").collapsible();$(".content").trigger("create")}}function filterRequest(f){var c=f.target.checked?1:0;var b=f.target.id,a=$(f.target).closest(".filter-collapse").attr("data-name");var e=b.split(":");if(c==1){sendAjaxRequest({url:"/ajaxSetFilterMessage?name="+a+"&node="+e[0],before:showLoader,success:g,complete:hideLoader,error:ajax_error})}else{sendAjaxRequest({url:"/ajaxDelFilterMessage?name="+a+"&node="+e[0],before:showLoader,success:d,complete:hideLoader,error:ajax_error})}function d(h){if(h.response===1){popOver("Sorry，稍后再试下嘛！")}if(h.response===0){popOver("取消屏蔽成功!")}}function g(h){if(h.response===1){popOver("Sorry，稍后再试下嘛！")}if(h.response===0){popOver("屏蔽成功!")}}}function ajaxSubmitMethod(){var a=[];$.each($("#alarm-form input"),function(e,c){var d=$(c);if(d.val()&&(d.attr("type")=="tel"||d.attr("type")=="text")){a.push(d.attr("name")+"-"+d.val())}});if(a.length==0){popOver("留个报警方式呗～");return}sendAjaxRequest({url:"/ajaxSetMethod?value="+a.join(":"),before:showLoader,success:b,complete:hideLoader,error:ajax_error});function b(c){if(c.response===1){popOver("Sorry，稍后再试下嘛！");return}if(c.response===0){popOver("接收报警方式设置成功～")}}}function ajaxSubmitProfile(b){var e="",a="",d=false;var c=$(b.target).closest("#profile-form");$.each(c.find("input"),function(j,f){var h=$(f).attr("type"),i=$(f).val();if(h=="tel"&&!i.match(/^0?1[3|4|5|8][0-9]\d{8}$/)){popOver("留个手机号码呗～");d=true;return false}if(h=="tel"||h=="text"||h=="number"){if($(f).val().length==0&&$(f).attr("name")!="oncaller"){popOver("要填写完整呦～");d=true;return false}var g=e?"&":"?";g=g+$(f).attr("name")+"="+$(f).val();e=e+g}});if(d){return false}$.each(c.find("option:selected"),function(g,f){if(a.length){a=a+":"+$(f).val()}else{a=a+$(f).val()}});if(a.length){e=e+"&follower="+a}sendAjaxRequest({url:encodeURI("/ajaxSetProfile"+e),before:showLoader,success:ajax_success,complete:hideLoader,error:ajax_error})}function triggerAlarm(){var a=$("#alarmValue").hasClass("ui-checkbox-on")?"off":"on";sendAjaxRequest({url:"/ajaxSetAlarm?value="+a,before:showLoader,success:b,complete:hideLoader,error:ajax_error});function b(d){var c=$("#alarmValue").hasClass("ui-checkbox-on")?"off":"on";if(d.response===1){popOver("Sorry，稍后再试下嘛！")}else{if(d.response===0){if(c=="on"){$(".alarm-change input[name='fullFormat']").checkboxradio("disable");$("#alarm-form input[type='button']").button("disable");$("#alarm-form input[type='text']").textinput("disable");$("#alarm-form input[type='tel']").textinput("disable");$("#alarm-form label").css("color","#aaa")}else{$(".alarm-change input[name='fullFormat']").checkboxradio("enable");$("#alarm-form input[type='button']").button("enable");$("#alarm-form input[type='text']").textinput("enable");$("#alarm-form input[type='tel']").textinput("enable");$("#alarm-form label").css("color","");if(_countdown>0){$("#testBtn").button("disable")}}popOver("恭喜！成功了yeah～")}}}}function triggerTest(){sendAjaxRequest({url:"/ajaxTriggerTest",before:showLoader,success:ajax_success,complete:hideLoader,error:ajax_error});$("#testBtn").button("disable");
_countdown=TIMEOUT;refreshBtn($("#testBtn"))}function refreshBtn(a){if(_countdown===0){a.val("设置测试").button("refresh");if($("#alarmValue").hasClass("ui-checkbox-on")){a.button("enable")}}else{a.val("剩余"+ --_countdown+"秒").button("refresh");setTimeout(function(){refreshBtn(a)},1000)}}function triggerFormat(){var a=$("#formatValue").hasClass("ui-checkbox-on")?"off":"on";sendAjaxRequest({url:"/ajaxSetFormat?value="+a,before:showLoader,success:ajax_success,complete:hideLoader,error:ajax_error})}function ajaxChangePWD(b){if($('input[name="new-pwd"]').val()!=$('input[name="confirm-pwd"]').val()){popOver("两次密码不一样呦～");return false}var c=false;$.each($('input[type="password"]'),function(j,g){if($(g).attr("name")=="old-pwd"){return true}var i=$(g).val();if(i.length<6){popOver("长度不小于6位呦～");c=true;return false}var h=new RegExp("[a-zA-Z]");if(!h.test(i)){popOver("至少包含一个字母呦～");c=true;return false}h=new RegExp("[0-9]");if(!h.test(i)){popOver("至少包含一个数字呦～");c=true;return false}h=new RegExp("[/#?@]");if(h.test(i)){popOver("不能包含/#?@符号呦～");c=true;return false}});if(c){return false}var a=$.md5($('input[name="old-pwd"]').val());var f=$.md5($('input[name="new-pwd"]').val());var d="?old="+a+"&new="+f;sendAjaxRequest({url:"/ajaxChangePWD"+d,before:showLoader,success:e,complete:hideLoader,error:ajax_error});function e(g){var h="";if(g.response===1){popOver("修改失败，稍后再试!")}else{if(g.response===0){popOver("修改成功!")}else{if(g.response===2){popOver("原始密码错误")}}}}};